<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AccessIQ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="user-navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <div class="logo">üîí AccessIQ</div>
                <div class="dashboard-title"><%= user.role %> Dashboard</div>
            </div>
            <div class="navbar-right">
                <span class="welcome-text">Welcome, <%= user.username %> (<%= user.role %>)</span>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- User Profile Section -->
        <div class="card">
            <h2>üë§ User Profile</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                <div>
                    <p><strong>Username:</strong> <%= user.username %></p>
                    <p><strong>Role:</strong> <%= user.role %></p>
                    <p><strong>Department:</strong> <%= user.department %></p>
                </div>
                <div>
                    <p><strong>Clearance Level:</strong> Level <%= user.clearance_level %></p>
                    <p><strong>Status:</strong> 
                        <span class="badge badge-success">Active</span>
                    </p>
                    <p><strong>Member Since:</strong> <%= new Date(user.created_at).toLocaleDateString() %></p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="showResources()" class="btn btn-primary" style="padding: 15px 30px; font-size: 16px; margin-right: 15px;">
                    üìö Access Resources
                </button>
                <button onclick="showEditProfile()" class="btn btn-success" style="padding: 15px 30px; font-size: 16px;">
                    üìù Edit Profile
                </button>
            </div>
        </div>

        <!-- Access Permissions Section -->
        <div class="card" id="permissionsSection">
            <h2>üîë Access Permissions</h2>
            <div class="permissions-divider"></div>
            
            <% if (!user.access_granted) { %>
                <div class="access-revoked-banner">
                    üö´ Access Revoked by Administrator
                </div>
            <% } %>
            
            <div class="permissions-grid">
                <div class="permission-card">
                    <div class="permission-header">
                        <span class="permission-icon">üè¢</span>
                        <h4>Department Access</h4>
                    </div>
                    <div class="permission-content">
                        <div class="department-item primary">
                            ‚úÖ <%= user.department %> (Primary)
                        </div>
                        <% if (typeof userDepartments !== 'undefined' && userDepartments.length > 0) { %>
                            <% userDepartments.forEach(dept => { %>
                                <div class="department-item">
                                    ‚úÖ <%= dept.department %>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="no-additional-access">
                                No additional department access
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div class="permission-card">
                    <div class="permission-header">
                        <span class="permission-icon">‚è∞</span>
                        <h4>Access Window</h4>
                    </div>
                    <div class="permission-content">
                        <div class="access-time">
                            <%= user.access_start_time || '09:00' %> - <%= user.access_end_time || '17:00' %> IST
                        </div>
                        <div class="time-note">
                            Your allowed access hours
                        </div>
                    </div>
                </div>
                
                <div class="permission-card">
                    <div class="permission-header">
                        <span class="permission-icon">üõ°Ô∏è</span>
                        <h4>Clearance Level</h4>
                    </div>
                    <div class="permission-content">
                        <div class="clearance-level level-<%= user.clearance_level %>">
                            Level <%= user.clearance_level %> - 
                            <% if (user.clearance_level === 1) { %>
                                Basic Access
                            <% } else if (user.clearance_level === 2) { %>
                                Medium Access
                            <% } else { %>
                                High Access
                            <% } %>
                        </div>
                        <div class="clearance-note">
                            <% if (user.clearance_level === 1) { %>
                                Can access basic academic resources
                            <% } else if (user.clearance_level === 2) { %>
                                Can access medium-sensitivity data
                            <% } else { %>
                                Can access high-sensitivity academic data
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <div class="permission-card">
                    <div class="permission-header">
                        <span class="permission-icon"><%= user.access_granted ? 'üü¢' : 'üî¥' %></span>
                        <h4>Access Status</h4>
                    </div>
                    <div class="permission-content">
                        <div class="access-status <%= user.access_granted ? 'active' : 'disabled' %>">
                            <%= user.access_granted ? 'Active' : 'Disabled' %>
                        </div>
                        <div class="status-note">
                            <%= user.access_granted ? 'You can access resources' : 'Contact administrator for access' %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Section (Initially Hidden) -->
        <div class="card" id="resourcesSection" style="display: none;">
            <h2>üìö Available Resources</h2>
            <p>Click "Request Access" to evaluate ABAC policies for each resource.</p>
            
            <table class="table">
                <thead>
                    <tr>
                        <th>Resource Name</th>
                        <th>Type</th>
                        <th>Department</th>
                        <th>Sensitivity Level</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% resources.forEach(resource => { %>
                        <tr>
                            <td><%= resource.name %></td>
                            <td><%= resource.resource_type %></td>
                            <td><%= resource.owner_department %></td>
                            <td>
                                <span class="badge <%= resource.sensitivity_level === 1 ? 'badge-success' : resource.sensitivity_level === 2 ? 'badge-warning' : 'badge-danger' %>">
                                    Level <%= resource.sensitivity_level %>
                                </span>
                            </td>
                            <td>
                                <a href="/access/<%= resource.id %>" class="btn btn-primary btn-sm">
                                    Request Access
                                </a>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <!-- Edit Profile Section (Initially Hidden) -->
        <div class="card" id="editProfileSection" style="display: none;">
            <h2>üìù Edit Profile</h2>
            <form id="profileForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="profileUsername">Username</label>
                        <input type="text" id="profileUsername" name="username" class="form-control" value="<%= user.username %>" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileRole">Role</label>
                        <input type="text" id="profileRole" name="role" class="form-control" value="<%= user.role %>" readonly>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="profileDepartment">Department</label>
                        <select id="profileDepartment" name="department" class="form-control" required>
                            <option value="Computer Science" <%= user.department === 'Computer Science' ? 'selected' : '' %>>Computer Science</option>
                            <option value="Mathematics" <%= user.department === 'Mathematics' ? 'selected' : '' %>>Mathematics</option>
                            <option value="Physics" <%= user.department === 'Physics' ? 'selected' : '' %>>Physics</option>
                            <option value="Administration" <%= user.department === 'Administration' ? 'selected' : '' %>>Administration</option>
                            <option value="IT" <%= user.department === 'IT' ? 'selected' : '' %>>IT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email (Optional)</label>
                        <input type="email" id="profileEmail" name="email" class="form-control" value="<%= user.email || '' %>">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="profilePassword">New Password (Leave blank to keep current)</label>
                    <input type="password" id="profilePassword" name="password" class="form-control" placeholder="Enter new password">
                </div>
                
                <div class="form-group">
                    <label for="profileConfirmPassword">Confirm New Password</label>
                    <input type="password" id="profileConfirmPassword" name="confirmPassword" class="form-control" placeholder="Confirm new password">
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" onclick="hideEditProfile()" class="btn btn-danger" style="margin-right: 15px;">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        üíæ Update Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showResources() {
            document.getElementById('resourcesSection').style.display = 'block';
            document.getElementById('editProfileSection').style.display = 'none';
            document.querySelector('button[onclick="showResources()"]').style.display = 'none';
            
            document.getElementById('resourcesSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        function showEditProfile() {
            document.getElementById('editProfileSection').style.display = 'block';
            document.getElementById('resourcesSection').style.display = 'none';
            document.querySelector('button[onclick="showResources()"]').style.display = 'inline-block';
            
            document.getElementById('editProfileSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        function hideEditProfile() {
            document.getElementById('editProfileSection').style.display = 'none';
        }
        
        // Handle profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('profilePassword').value;
            const confirmPassword = document.getElementById('profileConfirmPassword').value;
            
            if (password && password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            const formData = {
                department: document.getElementById('profileDepartment').value,
                email: document.getElementById('profileEmail').value,
                password: password || null
            };
            
            try {
                const response = await fetch('/profile/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Profile updated successfully!');
                    location.reload();
                } else {
                    alert('‚ùå ' + (result.error || 'Unable to update profile. Try again.'));
                }
            } catch (error) {
                alert('‚ùå Unable to update profile. Try again.');
            }
        });
    </script>
</body>
</html>