<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AccessIQ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="admin-page">
    <div class="admin-container">
        <nav class="admin-navbar">
            <div class="logo">
                üîí AccessIQ Admin
            </div>
            <div class="nav-right">
                <span class="welcome-text">Welcome, <%= user.username %></span>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </nav>
        
        <div class="admin-content">
        <% if (message) { %>
            <div class="alert alert-success" style="margin-bottom: 20px;">
                ‚úÖ <%= message %>
            </div>
        <% } %>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number"><%= pendingUsers.length %></div>
                <div class="stat-label">Pending Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><%= approvedUsers.length %></div>
                <div class="stat-label">Approved Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><%= logs.length %></div>
                <div class="stat-label">Recent Access Logs</div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="showTab('pending')">Pending Users</div>
                <div class="tab" onclick="showTab('approved')">Approved Users</div>
                <div class="tab" onclick="showTab('access-settings')">Manage User Access</div>
                <div class="tab" onclick="showTab('resources')">Manage Resources</div>
                <div class="tab" onclick="showTab('system')">System Management</div>
                <div class="tab" onclick="showTab('logs')">Access Logs</div>
            </div>

            <div id="pending" class="tab-content active">
                <h3>üë• Pending Approval</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% pendingUsers.forEach(user => { %>
                            <tr>
                                <td><%= user.username %></td>
                                <td><%= user.role %></td>
                                <td><%= user.department %></td>
                                <td><%= new Date(user.created_at).toLocaleDateString() %></td>
                                <td>
                                    <a href="/admin/user/<%= user.id %>" class="btn btn-primary btn-sm">Manage</a>
                                    <form method="POST" action="/admin/user/<%= user.id %>/approve" style="display: inline;">
                                        <button type="submit" class="btn btn-success btn-sm">‚úÖ Grant</button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <div id="approved" class="tab-content">
                <h3>‚úÖ Approved Users</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% approvedUsers.forEach(user => { %>
                            <tr>
                                <td><%= user.username %></td>
                                <td><%= user.role %></td>
                                <td><%= user.department %></td>
                                <td>
                                    <span class="badge <%= user.access_granted ? 'badge-success' : 'badge-danger' %>">
                                        <%= user.access_granted ? 'Approved' : 'Revoked' %>
                                    </span>
                                </td>
                                <td>
                                    <a href="/admin/user/<%= user.id %>" class="btn btn-primary btn-sm">Manage</a>
                                    <% if (user.access_granted) { %>
                                        <form method="POST" action="/admin/revoke/<%= user.id %>" style="display: inline;">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Revoke access for <%= user.username %>?')">üö´ Revoke</button>
                                        </form>
                                    <% } else { %>
                                        <form method="POST" action="/admin/user/<%= user.id %>/approve" style="display: inline;">
                                            <button type="submit" class="btn btn-success btn-sm">‚úÖ Grant</button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <div id="access-settings" class="tab-content">
                <h3>üîß Manage User Access Settings</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Access Hours</th>
                            <th>Clearance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (typeof allUsers !== 'undefined') { %>
                            <% allUsers.forEach(user => { %>
                                <% if (user.role !== 'Admin') { %>
                                    <tr>
                                        <td><%= user.username %></td>
                                        <td><%= user.role %></td>
                                        <td><%= user.department %></td>
                                        <td><%= user.access_start_time || '09:00' %> - <%= user.access_end_time || '17:00' %></td>
                                        <td>Level <%= user.clearance_level %></td>
                                        <td>
                                            <span class="badge <%= user.access_granted ? 'badge-success' : 'badge-danger' %>">
                                                <%= user.access_granted ? 'Enabled' : 'Disabled' %>
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" onclick="editUserAccess(<%= user.id %>, '<%= user.username %>', '<%= user.department %>', '<%= user.access_start_time || '09:00:00' %>', '<%= user.access_end_time || '17:00:00' %>', <%= user.clearance_level %>, <%= user.access_granted %>)">
                                                üìù Edit
                                            </button>
                                        </td>
                                    </tr>
                                <% } %>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <div id="resources" class="tab-content">
                <h3>üìö Add New Resource</h3>
                <form method="POST" action="/admin/add-resource" style="margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="name">Resource Name</label>
                            <input type="text" id="name" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="resource_type">Resource Type</label>
                            <select id="resource_type" name="resource_type" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="Assignment">Assignment</option>
                                <option value="Result">Result</option>
                                <option value="Report">Report</option>
                                <option value="Document">Document</option>
                                <option value="Database">Database</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="owner_department">Department</label>
                            <select id="owner_department" name="owner_department" class="form-control" required>
                                <option value="">Select Department</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sensitivity_level">Sensitivity Level</label>
                            <select id="sensitivity_level" name="sensitivity_level" class="form-control" required>
                                <option value="">Select Level</option>
                                <option value="1">Level 1 (Low)</option>
                                <option value="2">Level 2 (Medium)</option>
                                <option value="3">Level 3 (High)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">‚ûï Add Resource</button>
                </form>

                <h3>üìã Existing Resources</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Department</th>
                            <th>Sensitivity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (typeof allResources !== 'undefined') { %>
                            <% allResources.forEach(resource => { %>
                                <tr>
                                    <td><%= resource.name %></td>
                                    <td><%= resource.resource_type %></td>
                                    <td><%= resource.owner_department %></td>
                                    <td>
                                        <span class="badge <%= resource.sensitivity_level === 1 ? 'badge-success' : resource.sensitivity_level === 2 ? 'badge-warning' : 'badge-danger' %>">
                                            Level <%= resource.sensitivity_level %>
                                        </span>
                                    </td>
                                    <td>
                                        <form method="POST" action="/admin/delete-resource/<%= resource.id %>" style="display: inline;">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete <%= resource.name %>?')">üóëÔ∏è Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <div id="system" class="tab-content">
                <div class="system-management">
                    <div class="system-section">
                        <div class="section-header">
                            <h3>üè¢ Department Management</h3>
                            <button class="btn btn-primary" onclick="showAddDepartmentModal()">Add Department</button>
                        </div>
                        <div class="departments-list">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="departmentsTable">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="system-section">
                        <div class="section-header">
                            <h3>üë§ Role Management</h3>
                            <button class="btn btn-primary" onclick="showAddRoleModal()">Add Role</button>
                        </div>
                        <div class="roles-list">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rolesTable">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="logs" class="tab-content">
                <div class="logs-header">
                    <div class="logs-title">
                        <h3>üìä Recent Access Logs</h3>
                        <p class="logs-subtitle">Track all access decisions made by users and administrators</p>
                    </div>
                    <div class="logs-actions">
                        <input type="text" id="logSearch" class="log-search" placeholder="Search logs...">
                        <button class="btn btn-secondary btn-sm" onclick="exportLogs()">üìé Export</button>
                        <button class="btn btn-danger btn-sm" onclick="clearLogs()">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div class="logs-container">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Resource</th>
                                <th>Decision</th>
                                <th>Reason</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <% logs.forEach(log => { %>
                                <tr class="log-row">
                                    <td class="user-cell">
                                        <span class="user-avatar">üë§</span>
                                        <%= log.username %>
                                    </td>
                                    <td class="resource-cell"><%= log.resource_name || 'System Action' %></td>
                                    <td class="decision-cell">
                                        <span class="decision-badge <%= getDecisionClass(log.decision) %>">
                                            <%= getDecisionIcon(log.decision) %> <%= log.decision %>
                                        </span>
                                    </td>
                                    <td class="reason-cell"><%= log.reason %></td>
                                    <td class="time-cell">
                                        <span class="time-display">
                                            <%= new Date(log.timestamp).toLocaleDateString() %><br>
                                            <small><%= new Date(log.timestamp).toLocaleTimeString() %></small>
                                        </span>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <%
                function getDecisionClass(decision) {
                    switch(decision) {
                        case 'Permit': return 'decision-permit';
                        case 'Deny': return 'decision-deny';
                        case 'GRANT': return 'decision-grant';
                        case 'REVOKE': return 'decision-revoke';
                        case 'UPDATE': return 'decision-update';
                        default: return 'decision-default';
                    }
                }
                
                function getDecisionIcon(decision) {
                    switch(decision) {
                        case 'Permit': return 'üü¢';
                        case 'Deny': return 'üî¥';
                        case 'GRANT': return 'üü°';
                        case 'REVOKE': return 'üîµ';
                        case 'UPDATE': return 'üü†';
                        default: return '‚ö™';
                    }
                }
            %>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div id="addDepartmentModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Add New Department</h3>
                <button class="modal-close" onclick="closeModal('addDepartmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addDepartmentForm">
                    <div class="form-group">
                        <label for="deptName">Department Name</label>
                        <input type="text" id="deptName" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="deptDescription">Description</label>
                        <textarea id="deptDescription" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addDepartmentModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Department</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Role Modal -->
    <div id="addRoleModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Add New Role</h3>
                <button class="modal-close" onclick="closeModal('addRoleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addRoleForm">
                    <div class="form-group">
                        <label for="roleName">Role Name</label>
                        <input type="text" id="roleName" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="roleDescription">Description</label>
                        <textarea id="roleDescription" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addRoleModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Role</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Access Modal -->
    <div id="editAccessModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>üîß Edit Access Settings</h3>
                <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="editAccessForm" class="modal-body">
                <input type="hidden" id="editUserId">
                
                <div class="form-section">
                    <h4>Basic Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">Username</label>
                            <input type="text" id="editUsername" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editDepartment">Primary Department</label>
                            <select id="editDepartment" class="form-control" required>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Access Configuration</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editStartTime">Start Time</label>
                            <input type="time" id="editStartTime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editEndTime">End Time</label>
                            <input type="time" id="editEndTime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editClearance">Clearance Level</label>
                            <select id="editClearance" class="form-control" required>
                                <option value="1">Level 1 (Low)</option>
                                <option value="2">Level 2 (Medium)</option>
                                <option value="3">Level 3 (High)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Department Access Permissions</h4>
                    <div class="checkbox-grid" id="departmentCheckboxes">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div class="form-section">
                    <label class="checkbox-item access-enabled">
                        <input type="checkbox" id="editAccessGranted">
                        <span>Access Enabled</span>
                    </label>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'system') {
                loadSystemData();
            }
        }
        
        function loadSystemData() {
            loadDepartments();
            loadRoles();
        }
        
        function loadDepartments() {
            fetch('/admin/api/departments')
                .then(response => response.json())
                .then(departments => {
                    const tbody = document.getElementById('departmentsTable');
                    tbody.innerHTML = departments.map(dept => `
                        <tr>
                            <td><strong>${dept.name}</strong></td>
                            <td>${dept.description || 'No description'}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteDepartment(${dept.id}, '${dept.name}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => console.error('Error loading departments:', error));
        }
        
        function loadRoles() {
            fetch('/admin/api/roles')
                .then(response => response.json())
                .then(roles => {
                    const tbody = document.getElementById('rolesTable');
                    tbody.innerHTML = roles.map(role => `
                        <tr>
                            <td><strong>${role.name}</strong></td>
                            <td>${role.description || 'No description'}</td>
                            <td>
                                ${role.name !== 'Admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteRole(${role.id}, '${role.name}')">Delete</button>` : '<span class="text-muted">Protected</span>'}
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => console.error('Error loading roles:', error));
        }
        
        function showAddDepartmentModal() {
            document.getElementById('addDepartmentModal').style.display = 'block';
        }
        
        function showAddRoleModal() {
            document.getElementById('addRoleModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function deleteDepartment(id, name) {
            if (confirm(`Delete department "${name}"? This cannot be undone.`)) {
                fetch(`/admin/api/departments/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadDepartments();
                        } else {
                            alert(data.error || 'Failed to delete department');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete department');
                    });
            }
        }
        
        function deleteRole(id, name) {
            if (confirm(`Delete role "${name}"? This cannot be undone.`)) {
                fetch(`/admin/api/roles/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadRoles();
                        } else {
                            alert(data.error || 'Failed to delete role');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete role');
                    });
            }
        }
        
        // Form submissions
        document.getElementById('addDepartmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/admin/api/departments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('addDepartmentModal');
                    this.reset();
                    loadDepartments();
                } else {
                    alert(data.error || 'Failed to add department');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add department');
            });
        });
        
        document.getElementById('addRoleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/admin/api/roles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('addRoleModal');
                    this.reset();
                    loadRoles();
                } else {
                    alert(data.error || 'Failed to add role');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add role');
            });
        });
        
        async function editUserAccess(id, username, department, startTime, endTime, clearance, accessGranted) {
            console.log('Opening edit modal for user:', { id, username, department, startTime, endTime, clearance, accessGranted });
            
            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').value = username;
            document.getElementById('editDepartment').value = department || '';
            
            // Handle time values safely
            if (startTime && startTime !== 'null') {
                document.getElementById('editStartTime').value = startTime.substring(0, 5);
            } else {
                document.getElementById('editStartTime').value = '09:00';
            }
            
            if (endTime && endTime !== 'null') {
                document.getElementById('editEndTime').value = endTime.substring(0, 5);
            } else {
                document.getElementById('editEndTime').value = '17:00';
            }
            
            document.getElementById('editClearance').value = clearance || '1';
            document.getElementById('editAccessGranted').checked = Boolean(accessGranted);
            
            // Clear all department checkboxes
            document.querySelectorAll('input[name="dept_access"]').forEach(cb => cb.checked = false);
            
            // Load user's department access
            try {
                const response = await fetch(`/admin/api/users/${id}/departments`);
                if (response.ok) {
                    const departments = await response.json();
                    console.log('Loaded department access:', departments);
                    departments.forEach(dept => {
                        const checkbox = document.querySelector(`input[value="${dept.department}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    console.log('No department access data found');
                }
            } catch (error) {
                console.error('Failed to load department access:', error);
            }
            
            document.getElementById('editAccessModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editAccessModal').style.display = 'none';
        }
        
        document.getElementById('editAccessForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.innerHTML = 'üîÑ Saving...';
            submitButton.disabled = true;
            
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            
            if (startTime && endTime && startTime >= endTime) {
                alert('Start time must be before end time!');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                return;
            }
            
            const selectedDepartments = [];
            document.querySelectorAll('input[name="dept_access"]:checked').forEach(cb => {
                selectedDepartments.push(cb.value);
            });
            
            const formData = {
                department: document.getElementById('editDepartment').value,
                access_start_time: startTime || null,
                access_end_time: endTime || null,
                clearance_level: document.getElementById('editClearance').value,
                access_granted: document.getElementById('editAccessGranted').checked,
                department_access: selectedDepartments
            };
            
            console.log('Sending form data:', formData);
            
            try {
                const response = await fetch(`/admin/api/users/${document.getElementById('editUserId').value}/access`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                console.log('Server response:', result);
                
                if (response.ok) {
                    alert('‚úÖ Access settings updated successfully!');
                    closeEditModal();
                    location.reload();
                } else {
                    const errorMsg = result.details ? `${result.error}: ${result.details}` : result.error;
                    alert(`‚ùå ${errorMsg || 'Unable to update access settings. Try again.'}`);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('‚ùå Network error. Please check your connection and try again.');
            } finally {
                // Reset button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
        
        // Log search functionality
        document.getElementById('logSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.log-row');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        
        function exportLogs() {
            const table = document.querySelector('.logs-table');
            const rows = Array.from(table.querySelectorAll('tr:not([style*="display: none"])'));
            
            let csv = 'User,Resource,Decision,Reason,Time\n';
            
            rows.slice(1).forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[0].textContent.trim().replace('üë§ ', ''),
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim().replace(/[üü¢üî¥üü°üîµüü†‚ö™]/g, '').trim(),
                    cells[3].textContent.trim(),
                    cells[4].textContent.trim().replace(/\n/g, ' ')
                ];
                csv += rowData.map(field => `"${field}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `access_logs_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function clearLogs() {
            if (confirm('Are you sure you want to clear all access logs? This action cannot be undone.')) {
                fetch('/admin/api/logs/clear', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('‚úÖ Access logs cleared successfully!');
                        location.reload();
                    } else {
                        alert('‚ùå Failed to clear logs. Try again.');
                    }
                })
                .catch(error => {
                    alert('‚ùå Network error. Please try again.');
                });
            }
        }
    </script>
        </div>
    </div>
</body>
</html>